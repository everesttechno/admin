name: Call by required workflow

on:
  push:
    paths:
      - .github/workflows/**
  pull_request:
    paths:
      - .github/workflows/**

jobs:
  analyze:
    name: Analyze 
    runs-on: 'ubuntu-latest'
    permissions:
      # required for all workflows
      security-events: write

    strategy:
      fail-fast: false
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Prepare CodeQL CLI
      run: |
        curl -L "https://github.com/github/codeql-action/releases/download/${CODEQL_VERSION}/${CODEQL_ARCHIVE}" -o codeql-bundle.tar.gz
        mkdir codeql-cli
        tar -xzf codeql-bundle.tar.gz -C codeql-cli --strip-components=1

        # Add CodeQL CLI to PATH for subsequent steps
        echo "${PWD}/codeql-cli" >> $GITHUB_PATH
        echo "CodeQL CLI set up at: ${PWD}/codeql-cli"
        codeql resolve packs

    - name: Create codeql db
      run: codeql database create codeql-db --language=actions --source-root ./

    - name: Run codeql analysis
      run: codeql database analyze codeql-db --format=sarif-latest --output=/tmp/codeql-results.sarif
